<!-- *** -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./asset/css/style.css" />
    <link rel="stylesheet" href="./asset/css/mainstyle.css" />
    <link rel="stylesheet" href="./asset/css/reset.css" />
    <link rel="stylesheet" href="./asset/css/button.css" />
  </head>
  <body>
    <div class="container">
      <div class="navBar">
        <div
          style="
            padding: 0 50px;
            display: flex;
            width: 100%;
            justify-content: space-between;
          "
        >
          <div class="logo">
            <p style="margin-left: 5px; font-size: xx-large">
              <a
                class="font"
                style="text-decoration: none; color: #5f6368"
                href="index.html"
                >Book.</a
              >
            </p>
          </div>

          <div class="nav-content" style="display: flex; align-items: center">
            <button
              class="buttonsty addBook"
              type="button"
              style="
                background-color: rgba(28, 156, 92, 0.774);
                width: 150px;
                margin-right: 20px;
              "
            >
              + Th√™m Truy·ªán
            </button>

            <div class="username" style="display: flex; align-items: center">
              <a href="addbook copy.html">
                <div
                  style="
                    border: 0px solid;
                    border-radius: 50%;
                    background-color: gray;
                    width: 35px;
                    height: 35px;
                    margin-right: 5px;
                  "
                ></div>
              </a>
              <div>
                <a
                  href="addbook copy.html"
                  class="font"
                  style="text-decoration: none; color: #5f6368"
                >
                  <p class="user">ƒêang t·∫£i...</p>
                </a>
              </div>
            </div>

            <button
              class="buttonsty logout"
              type="button"
              style="
                background-color: rgba(255, 61, 61, 0.774);
                width: 100px;
                margin-left: 20px;
              "
            >
              Log out
            </button>
          </div>
        </div>
      </div>

      <div class="display">
        <h2 class="font">Truy·ªán c·ªßa t√¥i</h2>
        <div id="book" style="display: grid;"></div>
      </div>
    </div>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        doc,
        updateDoc,
        deleteDoc,
        query,
        orderBy,
        where,
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional

      const firebaseConfig = {
        apiKey: "AIzaSyCqtouu7EB6vThIRKJ6VSA8MURsIXQfuWI",
        authDomain: "book-4469c.firebaseapp.com",
        projectId: "book-4469c",
        storageBucket: "book-4469c.firebasestorage.app",
        messagingSenderId: "597597915442",
        appId: "1:597597915442:web:ff624237ef7d52961d6f2b",
        measurementId: "G-8DNPL9NF8P",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      let currentUser = "";

      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user.email;
          document.querySelector(".user").innerText = currentUser;
          loadBook();
        } else {
          window.location.href = "login.html";
        }
      });

      document.querySelector(".logout").addEventListener("click", async () => {
        if (confirm("Sign Out?")) {
          signOut(auth)
            .then(() => {
              console.log("sign out");
            })
            .catch((error) => {
              console.error(error);
            });
        } else {
          return;
        }
      });

      async function loadBook() {
        const book = document.getElementById("book");
        book.classList.add("empty");
        book.innerHTML = "<p class='empty-message font'>ƒêang t·∫£i...</p>";

        try {
          const q = query(
            collection(db, "book"),
            where("publisher", "==", currentUser),
            orderBy("title")
          );
          const querySnapshot = await getDocs(q);

          if (querySnapshot.empty) {
            book.classList.add("empty");
            book.innerHTML =
              "<p class='empty-message font'>Ch∆∞a c√≥ truy·ªán n√†o.</p>";
            return;
          }

          let html = "";

          querySnapshot.forEach((docSnap) => {
            const showbook = docSnap.data();
            const id = docSnap.id;

            html += `<div
            class="book-card font"
            >
            <div class="book-body" style="display: flex; margin: 10px;">
              <img
              src="${showbook.img}"
              alt="${showbook.img}"
              class="book-img"
              onerror="this.src='https://dulichthuyphico.com/img/no-image.png'"
              style="height: 220px; width: 160px; background-color: gray; border-radius: 5px;"
              />
              
              <div class="book-info" style="margin-left: 10px;">
                <h3 class="book-title">${showbook.title}</h3>
            <p class="overflow">
              <span>üìÖ</span> <strong>Ng√†y:</strong> ${showbook.date}
            </p>
            <p class="overflow">
              <span>üìù</span> <strong>M√¥ t·∫£:</strong> ${showbook.des}
              </p>
              <p class="overflow">
              <span>üë§</span> <strong>Ng∆∞·ªùi:</strong> ${showbook.publisher}
              </p>
              <p class="overflow"><strong>ID:</strong> ${id}</p>
              </div>
              </div>
              
              <div class="book-actions" style="margin: 10px;">
                <button
                class="buttonsty"
                style="width: 100px; background-color: rgb(46, 120, 145)"
                onclick="editBook('${id}')"
          >
          S·ª≠a
          </button>
          <button
          class="buttonsty"
          style="width: 100px; background-color: rgb(180, 46, 46)"
          onclick="deleteBook('${id}')"
          >
          X√≥a
          </button>
          </div>
          </div>
          `;
          });
          book.innerHTML = html;
        } catch (error) {
          book.innerHTML = `<p class='error-message'>L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</p>`;
        }
      }

      window.deleteBook = async (id) => {
        if (confirm("Delete?")) {
          try {
            await deleteDoc(doc(db, "book", id));
            loadBook();
          } catch (error) {
            alert(error.message);
          }
        } else {
          return;
        }
      };

      document.querySelector(".addBook").addEventListener("click", async () => {
        window.location.href = "addbook.html";
      });
    </script>
  </body>
</html>
